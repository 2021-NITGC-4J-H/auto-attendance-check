# 仕様書　テーマ名：画像認識を用いた自動出欠確認システムの作成

H班　　井澤慶広　田中英行

## 概略

出欠確認は毎授業開始時に教師が直接行っているが、欠席の学生が多い場合などには時間と労力の消費が大きい。
そこで、教室上部から撮影した画像を用いて各学生の出欠確認を自動で行い、教師の負担を減らす。
出欠確認を行うシステム部とGUI部を別のパッケージとして配布し、学校で広く使用できるようにする。

## システム構成

### 画像読み込み

教室上部に設置したカメラで、授業開始時に教室全体を撮影する。
カメラと接続したラズベリーパイに画像データを送信する。
遅刻した生徒も確認する必要があるため、その後も定期的に撮影する。撮影感覚はラズベリーパイで管理する。

### 画像解析

カメラから送信されたデータをもとに、OpenCVを用いた顔認証で各学生の出欠を判断する。
以下に、画像解析の具体的な方法を記す。

#### システム使用前

システム使用前に、前もって教室の座席表を入力し、座席と学生の関係を把握しておく。

#### 出欠確認

##### (A)授業開始時に撮影した場合

1．撮影した画像からすべての机の座標・前後左右の位置関係を記憶する。
2．OpenCVで処理できるよう画像を白黒に変換する。
3．画像に含まれる顔を全て検出し、検出した顔の座標を記憶する。
4．顔の座標・「[授業開始時に撮影した場合](#(A)授業開始時に撮影した場合)」で記憶した机の座標・システム使用前に入力した座席と学生の関係から、机にいる人物を判定する。

##### (B)遅刻確認のために撮影した（授業内で2回目以降の撮影）場合

　[授業開始時に撮影した場合](#(A)授業開始時に撮影した場合)の2~4を行う。

#### データまとめ

出欠確認段階で各学生の出欠状況を確認したが、このままではデータとして出力する際に管理が困難。
そこで、各学生の出欠を1つのデータにまとめ、クラス・日付・科目名の要素を付与する。
このまとめたデータを「データ出力」部に渡す。

### データ更新

画像解析部から渡された各学生の出欠データを、指定したファイル形式で更新する。
データは学校ごとに管理し、ファイル形式は学校に1つあるメインシステムで指定する。
データは「学校->クラス->科目ごとの出席状況」という枝構造で管理する。
出欠データにある「クラス」と「科目名」から更新場所を特定し、出欠状況を更新する。

### 概要図

以下にシステム構成の概要図を示す。
GUI部分を教員PCで操作し、画像の撮影・解析・出力をラズベリーパイで行うことによって
メンテナンス性を向上させ、変更にも強いソフトウェアを実現する。

![システム構成図](https://i.imgur.com/6aw2uOl.png)

## 機能の説明

### GUI

GUIを使用することで、教員から生徒たちの出欠データの確認および修正を行えるようにする。

具体的には、教員のPCとマイコンとを無線によって通信することで[システム](#システム構成)にアクセスし実行を行えるようにする。

このGUI部分はMVCアーキテクチャを採用するため、以下にそれぞれの動作内容を示す。

#### model

マイコンや、teams、onedriveなどとのやり取りを行うことで、UIとロジックの分離を図る。
また、マイコンなどからのデータの変更などをviewに出力する。

#### view

UIの表示を担う

#### controller

ユーザからの入力をmodelへのメッセージへと変換してmodelに伝える

### データ管理

microsoft onedriveを使用して出欠表と同様のデータの保存を行う。
また、指定したユーザーから確認及び編集できるようにする。

### 欠席連絡

microsoft teamsを用いて欠席者に対して欠席連絡を行う。

## 統合テスト

Pytestを用いてソフトウェアテストを行う。

作成した関数に対して

- 処理が要件を満たすかどうか
- 欠陥がないかどうか
- 品質を満たしているかどうか

の確認を行うテストを作成し、実行する

### 操作方法の概略

- 基本的にはラズベリーパイにインストールした出席自動確認プログラムを使用
- 出席状況の確認・編集には、PCにインストールしたGUIアプリを使用

### 処理の流れ

- ラズベリーパイによって撮影（教室に設置したカメラ）
→ラズベリーパイで画像解析
→ラズベリーパイでデータをまとめる
→データをNASまたは外部クラウドに送信
- NASまたは外部クラウドでは学校の全クラス・全科目のデータを一括管理
- 先生のPCではNASまたは外部クラウドに接続し、閲覧・編集が可能

### 実行環境

- ラズベリーパイ
  - 画像撮影
  - 画像解析
  - 出欠データ出力
- windwos
  - GUI

### 開発環境

- windows10, 11
- visual studio code
- PyCharm

### 使用言語

- python3

### 使用ライブラリ

- opencv2
 画像処理
 <https://github.com/opencv/opencv>
- numpy
 数値計算
 <https://github.com/numpy/numpy>
- pandas
 データ分析
 <https://github.com/pandas-dev/pandas>
- tkinter
 GUI
 <https://docs.python.org/ja/3/library/tkinter.html>
 <https://github.com/python/cpython/tree/main/Lib/tkinter>
- pytest
 テスト
 <https://github.com/pytest-dev/pytest>

### 使用部品

- Wifi機能を持ったラズベリーパイ
- 小型カメラ
